<!-- chat/chat.html -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with {{ recipient.username }}</title>
</head>
<body>
    <h2>Chat with {{ recipient.username }}</h2>
    <div id="chat-log">
        {% for message in messages %}
            <p>{{ message.sender.username }}: {{ message.content }}</p>
        {% endfor %}
    </div>
    <form id="chat-form" method="post" action="">
        {% csrf_token %}
        {{ form.message }}
        <button type="submit">Send</button>
    </form>

    <script>
        const chatSocket = new WebSocket(
            'ws://' + window.location.host + '/ws/chat/{{ recipient.id }}/'
        );
        function connectWebSocket() {
        if (chatSocket.readyState !== WebSocket.OPEN) {
            chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/{{ recipient.id }}/');
            
            // Add event listeners for the new socket
            chatSocket.onopen = function(event) {
                console.log('Reconnected to WebSocket.');
                // Perform actions or send messages upon successful reconnection
            };

            chatSocket.onclose = function(event) {
                console.log('WebSocket connection closed.');
                // Handle closure, such as attempting to reconnect
                setTimeout(connectWebSocket, 3000); // Reconnect after 3 seconds (adjust as needed)
            };

            chatSocket.onerror = function(event) {
                console.error('WebSocket error observed:', event);
                // Handle any errors that might occur
            };

            chatSocket.onmessage = function(event) {
                console.log('Received message:', event.data);
                // Process incoming messages
            };
        }
    }

// Call the function to start or reconnect the WebSocket

        // WebSocket connection setup

        // Handle incoming messages from WebSocket
        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            document.querySelector('#chat-log').innerHTML += '<p>' + data.message + '</p>';
        };

        // Handle form submission
        document.querySelector('#chat-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const messageInput = document.querySelector('#id_message');
            const message = messageInput.value.trim();

            if (message) {
                if (chatSocket.readyState !== WebSocket.OPEN) {
                    connectWebSocket();
                    console.log('Socket is open and ready to communicate.');
                } 
                chatSocket.send(JSON.stringify({
                    'message': message,
                    'sender_id': {{ request.user.id }},
                    'recipient_id': {{ recipient.id }}
                }));
                messageInput.value = '';
            }
        });
    </script>
</body>
</html>
